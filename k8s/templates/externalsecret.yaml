# ExternalSecret: sincroniza secrets do AWS Secrets Manager para Kubernetes Secret
# O External Secrets Operator monitora este recurso e:
# 1. Conecta ao AWS Secrets Manager usando IRSA (via SecretStore)
# 2. Busca os secrets definidos em data[]
# 3. Cria/atualiza um Kubernetes Secret com os valores
# 4. Re-sincroniza automaticamente a cada refreshInterval
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "telemetry-intake-api.fullname" . }}-externalsecret
  namespace: {{ .Release.Namespace }}
  labels: {{- include "telemetry-intake-api.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h  # sincroniza a cada 1 hora para pegar mudanças
  secretStoreRef:
    name: {{ include "telemetry-intake-api.fullname" . }}-secretstore
    kind: SecretStore
  target:
    name: {{ include "telemetry-intake-api.fullname" . }}-secrets  # nome do Secret K8s criado
    creationPolicy: Owner  # External Secret é dono do Secret (será deletado junto)
  data:
    # Mapeia secrets do AWS Secrets Manager para chaves do Kubernetes Secret
    # secretKey: nome da chave no Secret K8s
    # remoteRef.key: nome do secret no AWS Secrets Manager
    # remoteRef.property: campo JSON (quando secret é JSON)
    #PREENCHER E MUDAR TODOS ABAIXO
    - secretKey: connectionString
      remoteRef:
        key: fcg-api-game-connection-string  # secret em AWS Secrets Manager

    - secretKey: jwt-issuer
      remoteRef:
        key: fcg-jwt-config      # secret JSON no AWS Secrets Manager
        property: issuer          # campo "issuer" do JSON
    
    - secretKey: jwt-audience
      remoteRef:
        key: fcg-jwt-config
        property: audience
    
    - secretKey: jwt-key
      remoteRef:
        key: fcg-jwt-config
        property: key